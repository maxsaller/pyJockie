services:
  init-fifo:
    image: alpine:latest
    command: sh -c "test -p /mnt/pipe/spotify.fifo || mkfifo /mnt/pipe/spotify.fifo"
    volumes:
      - audio-pipe:/mnt/pipe
    restart: "no"

  librespot:
    image: giof71/librespot:latest
    container_name: pyjockie-librespot
    network_mode: host
    depends_on:
      init-fifo:
        condition: service_completed_successfully
    environment:
      - BACKEND=pipe
      - DEVICE=/mnt/pipe/spotify.fifo
      - DEVICE_NAME=PyJockie
      - BITRATE=320
      - FORMAT=S16
      - INITIAL_VOLUME=100
      - ENABLE_CACHE=Y
      - ENABLE_SYSTEM_CACHE=Y
      - ONEVENT_POST_ENDPOINT=http://127.0.0.1:8080/api/librespot-event
    volumes:
      - audio-pipe:/mnt/pipe
      - librespot-cache:/data/cache
      - librespot-system-cache:/data/system-cache
    restart: unless-stopped

  bot:
    build:
      context: ./bot
      dockerfile: Dockerfile
    container_name: pyjockie-bot
    network_mode: host
    depends_on:
      init-fifo:
        condition: service_completed_successfully
    environment:
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - FIFO_PATH=/mnt/pipe/spotify.fifo
      - EVENT_PORT=8080
    volumes:
      - audio-pipe:/mnt/pipe
    restart: unless-stopped

volumes:
  audio-pipe:
  librespot-cache:
  librespot-system-cache:
